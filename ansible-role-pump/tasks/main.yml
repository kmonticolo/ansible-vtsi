---
# tasks file for ansible-role-pump
- name: Include vars
  include_vars:
    file: hosts.yml

- name: Touch hostname
  file:
    state: touch
    path: /etc/hostname
    modification_time: "preserve"
    access_time: "preserve"

- name: Set hostname
  lineinfile:
    dest: /etc/hostname
    line: "{{ pump_hostname }}"

- name: Change external TimeSource in CCURtimemon
  lineinfile:
    path: "{{ ccurtimemon }}"
    regexp: '^EXTERNAL_TS='
    line: 'EXTERNAL_TS={{ externalts_ip }}'
  notify: Restart ccurtimemon service

- name: Change primary TimeSource in CCURtimemon
  lineinfile:
    path: "{{ ccurtimemon }}"
    regexp: '^PRIMARY_TS='
    line: 'PRIMARY_TS={{ pump_ip }}'
  notify: Restart ccurtimemon service

- name: Run ntpconfig
  command: ntpconfig /etc
  changed_when: false

- name: Flush handlers
  meta: flush_handlers

- name: Generate {{ mhresource }} file
  template:
    src=templates/resource.cfg.j2
    dest="{{ mhresource }}"
  notify: Restart VOD

- name: Make sure /etc/opt/MediaHawk/VODAddressMap is configured
  copy:
    content: '{{ ansible_default_ipv4.network }} {{ ansible_default_ipv4.netmask }} {{ ansible_default_ipv4.address }}'
    dest: /etc/opt/MediaHawk/VODAddressMap
    force: no
  notify: Restart VOD

- name: Flush handlers
  meta: flush_handlers
